name: Build Starwind

on:
  push:
    branches: master
    tags: ['*']

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions: write-all

    outputs:
      release_name: ${{ steps.release_type.outputs.release_name }}
      tagged: ${{ steps.release_type.outputs.tagged }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine Release Type and Cleanup
        id: release_type
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "tagged=true" >> $GITHUB_OUTPUT
            echo "release_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "tagged=false" >> $GITHUB_OUTPUT
            echo "release_name=development" >> $GITHUB_OUTPUT
            
            release_id=$(gh release list --limit 100 | grep "development" | awk '{print $1}' | head -1)
            if [ -n "$release_id" ]; then
              echo "Deleting existing development release: $release_id"
              gh release delete "$release_id" --yes
            else
              echo "No existing development release found"
            fi
          fi

  # TSI Job runs separately due to database scripts depending on it
  build-tsi:
    needs: cleanup
    runs-on: ubuntu-latest

    container: ghcr.io/dreamweave-mp/makron:latest

    permissions: write-all
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Dependency Files

        env:
          MTM_DECRYPT_KEY: ${{ secrets.MTM_DECRYPT_KEY }}

        run: mkdir -p build && ./writeDependencyFiles build

      - name: Build TSI
        run: make tsi

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.cleanup.outputs.release_name }}
          prerelease: ${{ needs.cleanup.outputs.tagged == 'false' }}
          files: Starwind-TSI.omwaddon

      - name: Upload Database Artifact
        uses: actions/upload-artifact@v4
        with:
          name: starwind-tsi-build
          path: Starwind-TSI.omwaddon
          retention-days: 1

  build-variants:
    needs: cleanup
    runs-on: ubuntu-latest

    container: ghcr.io/dreamweave-mp/makron:latest

    permissions:
      contents: write

    strategy:
      matrix:
        include:
          - make_target: vanilla
            output_file: Starwind-Solo.omwaddon
            variant_name: Vanilla
          
          - make_target: standalone
            output_file: Starwind-Standalone.omwaddon
            variant_name: Vanilla
          
          - make_target: cpp
            output_file: Starwind_Community_Patch_Project.zip
            variant_name: Community Patch Project
    
    outputs:
      variant_file: ${{ steps.rename.outputs.variant_file }}
      variant_name: ${{ matrix.variant_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Dependency Files
        env:
          MTM_DECRYPT_KEY: ${{ secrets.MTM_DECRYPT_KEY }}
        run: mkdir -p build && ./writeDependencyFiles build
      
      - name: Build Variant
        run: make ${{ matrix.make_target }}

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.cleanup.outputs.release_name }}
          prerelease: ${{ needs.cleanup.outputs.tagged == 'false' }}
          files: ${{ matrix.output_file }}

  build-databases:
    defaults:
      run:
        shell: bash
        working-directory: /plugins

    needs: [cleanup, build-tsi]
    runs-on: ubuntu-latest

    container: ghcr.io/dreamweave-mp/makron:latest

    permissions:
      contents: write

    strategy:
      matrix:
        include:
          - make_target: MIG
            output_file: merchantIndexDatabase.json
            variant_name: Merchant Database
          
          - make_target: espParser
            output_file: StarwindDB.tar.gz
            variant_name: Cell Database
          
          - make_target: kTools
            output_file: kToolsDB.tar.gz
            variant_name: kDump
          
          - make_target: requiredfiles
            output_file: requiredDataFiles.json
            variant_name: Required Data Files
          
          - make_target: DFL
            output_file: DFLDB.tar.gz
            variant_name: Data Files Loader
    
    outputs:
      variant_file: ${{ steps.rename.outputs.variant_file }}
      variant_name: ${{ matrix.variant_name }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
    
      - name: Download TSI Build
        uses: actions/download-artifact@v4
        with:
          name: starwind-tsi-build

      - name: Extract Dependency Files
        env:
          MTM_DECRYPT_KEY: ${{ secrets.MTM_DECRYPT_KEY }}
        run: ${GITHUB_WORKSPACE}/writeDependencyFiles && mv ${GITHUB_WORKSPACE}/Starwind-TSI.omwaddon .
      
      - name: Build Database Variant
        run: make -f ${GITHUB_WORKSPACE}/Makefile ${{ matrix.make_target }} && rm *.es*

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.cleanup.outputs.release_name }}
          prerelease: ${{ needs.cleanup.outputs.tagged == 'false' }}
          files: ${{ matrix.output_file }}
