stages:
  - build
  - dump

variables:
  build_img: "$CI_REGISTRY/modding-openmw/makron:0.0.9"
  curl_img: curlimages/curl:7.83.0
  pkg_name: "${CI_PROJECT_NAME}.zip"
  pkg_url:
    "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CI_PROJECT_NAME}/${CI_COMMIT_TAG}"

build_tsi:
  image: ${build_img}
  stage: build
  script:
  - make tsi
  artifacts:
    paths:
      - "Starwind.omwaddon"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

build_vanilla:
  image: ${build_img}
  stage: build
  script:
  - make vanilla
  artifacts:
    paths:
      - "vanilla_Starwind.omwaddon"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

build_cpp:
  image: ${build_img}
  stage: build
  script:
  - make cpp
  artifacts:
    paths:
      - "Starwind Community Patch Project.omwaddon"
      - "Meshes"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

dump_merchants:
  image: ${build_img}
  stage: dump
  script:
  - merchantIndexGrabber
  artifacts:
    paths:
      - "merchantIndexDatabase.json"
  dependencies:
    - build_tsi
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

dump_cells:
  image: ${build_img}
  stage: dump
  script:
  - make espParser
  artifacts:
    paths:
      - "StarwindDB.zip"
  dependencies:
    - build_tsi
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

dump_DFL:
  image: ${build_img}
  stage: dump
  script:
  - make DFL
  artifacts:
    paths:
      - "DFLDB.zip"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

dump_kTools:
  image: ${build_img}
  stage: dump
  script:
  - make kTools
  artifacts:
    paths:
      - "kToolsDB.tar.gz"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

dump_requiredDataFiles:
  image: ${build_img}
  stage: dump
  script:
  - make requiredfiles
  artifacts:
    paths:
      - "requiredDataFiles.json"
  rules:
    - if: $CI_COMMIT_BRANCH == "master"
